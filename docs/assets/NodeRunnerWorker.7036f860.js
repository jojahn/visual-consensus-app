var E=Object.defineProperty,I=Object.defineProperties;var b=Object.getOwnPropertyDescriptors;var l=Object.getOwnPropertySymbols;var T=Object.prototype.hasOwnProperty,y=Object.prototype.propertyIsEnumerable;var u=(o,t,e)=>t in o?E(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,a=(o,t)=>{for(var e in t||(t={}))T.call(t,e)&&u(o,e,t[e]);if(l)for(var e of l(t))y.call(t,e)&&u(o,e,t[e]);return o},h=(o,t)=>I(o,b(t));function d(){return typeof crypto!="undefined"&&crypto.randomUUID?crypto.randomUUID():v()}function v(o=6,t=36){return Math.random().toString(t).substring(2,o)}class N{constructor(t,e){this.neighbors=[],this.node=t,this.neighbors=e&&this.neighbors.concat(e)}getAllNeighbors(){return this.neighbors}getNeighborsOfType(t){return this.neighbors.filter(e=>e.type===t)}getRandomNeighborOfType(t){const e=this.getNeighborsOfType(t),s=Math.floor(Math.random()*e.length);return e[s]}broadcast(t,e){const s=d(),n=this.node.id;for(const i of e)i!==n&&this.emit(h(a({},t),{sent:new Date().toISOString(),id:this.getRandomId(),broadcastKey:s,fromId:n,toId:i}))}broadcastToAll(t){const e=this.neighbors.map(s=>s.id);this.broadcast(t,e)}broadcastToType(t,e){const s=this.neighbors.filter(n=>n.type===e).map(n=>n.id);this.broadcast(t,s)}sendTo(t,e){const s=this.node.id;this.emit(h(a({},e),{sent:new Date().toISOString(),fromId:s,toId:t,id:this.getRandomId()}))}sendToSync(t,e){const s=this.node.id;return this.emitSync(h(a({},e),{sent:new Date().toISOString(),fromId:s,toId:t,id:this.getRandomId()}))}emit(t){window.dispatchEvent(new CustomEvent("NetworkEvent",{detail:h(a({},t),{nodeId:this.node.id})}))}emitSync(t){const e=d();return new Promise(s=>{this.emit(h(a({},t),{resKey:e}));const n=this.listen(i=>{i.resKey===e&&(n(),s(i))})})}listen(t){const s=(n=>i=>i.detail.toId===this.node.id&&n(i.detail))(t);return window.addEventListener("NetworkEvent",s),()=>{window.removeEventListener("NetworkEvent",s)}}async receive(){return new Promise(t=>{this.listen(e=>{t(e)})})}getRandomId(){return"M_"+d()}}class g extends N{constructor(t,e){super(t,e)}emit(t){self.postMessage(t)}listen(){return()=>{}}}class p{constructor(t,e,s,n){this.id=t,this.config=e,this.state=s,this.network=n,this.running=!0,this.connected=!0,this.executedCommands=[],this.scheduledCommands=[]}stop(){this.running=!1}restart(){this.running=!0,this.scheduledCommands.forEach(t=>{t.do(),this.executedCommands.push(t)})}reconnect(){this.connected=!0}disconnect(){this.connected=!1}invoke(t){const e=d();let s=t;typeof s=="function"?s={id:e,do:t,undo:()=>console.warn("Undo not implemented")}:s.id=e,this.running?(s.do(),this.executedCommands.push(s)):this.scheduledCommands.push(s),this.updateState()}step(t=!0){if(t&&this.scheduledCommands.length>0){const e=this.scheduledCommands.shift();e.do(),this.executedCommands.push(e)}else if(this.executedCommands.length>0){const e=this.executedCommands.pop();e.undo(),this.scheduledCommands.push(e)}this.updateState()}invokeDo(t){const e=a({},this.state),s={do:()=>{t()},undo:()=>{this.state=e}};this.invoke(s)}updateState(){this.network.sendTo(void 0,{type:"STATE_CHANGED",isFlow:!0,data:a({},this.state)})}}class S extends p{constructor(t,e,s,n){super(t,e,s,n),this.type="client"}request(t,e){const s=this.state.state;return{do:()=>{this.state.text="WAITING",this.network.sendTo(t,{method:"REQUEST",v:e}),this.updateState()},undo:()=>{this.state.text=s}}}onmessage(t){t.method==="RESPONSE"&&this.invoke(this.onAck())}onAck(){const t=this.state.text;return{do:()=>{this.state.text="DONE"},undo:()=>{this.state.text=t}}}requestRandom(t){const e=this.network.getRandomNeighborOfType("proposer")||this.network.getRandomNeighborOfType("node");this.invoke(this.request(e.id,t))}}class R{constructor(t,e,s,n){this.id=t,this.config=s,this.parentNode=n,this.network=e,this.state={greatestN:-1,text:"IDLE"}}onPrepare(t){let e={state:a({},this.state),parentState:a({},this.parentNode.state)};return{do:()=>{if(t.n<=this.parentNode.state.greatestN){this.state.text="IDLE",this.network.sendTo(t.fromId,{clientId:t.clientId,n:this.parentNode.state.greatestN,method:"IGNORED"});return}this.parentNode.state.greatestN=t.n,this.state.text="PROMISED",this.network.sendTo(t.fromId,{method:"PROMISE",clientId:t.clientId,n:t.n})},undo:()=>{this.state=e,this.parentNode.state=e.parentState}}}onAccept(t){let e={state:a({},this.state),parentState:a({},this.parentNode.state)};return{do:()=>{if(t.n>this.parentNode.state.greatestN){this.state.text="IDLE";const s={clientId:t.clientId,n:this.parentNode.state.greatestN,v:t.v,method:"IGNORED"};this.network.sendTo(t.fromId,s);return}this.state.text="ACCEPTED",this.config.learnerImpl==="contactAllAcceptors"?this.network.broadcastToType({clientId:t.clientId,n:t.n,v:t.v,method:"ACCEPTED"},"node"):(this.network.sendTo(t.fromId,{clientId:t.clientId,n:t.n,v:t.v,method:"ACCEPTED"}),this.parentNode.state.log[t.n-1]=t.v),this.parentNode.state.greatestN=t.n},undo:()=>{this.state=e.state,this.parentNode.state=e.parentState}}}}class M{constructor(t,e,s,n){this.network=e,this.config=s,this.parentNode=n,this.id=t,this.state={v:null,n:null}}onAccepted(t){const e=this.state.v,s=[...this.parentNode.state.log];return{do:()=>{t.v===this.state.v&&t.n===this.state.n||(this.state.v=t.v,this.state.n=t.n,this.parentNode.state.log[t.n-1]=t.v,this.network.sendTo(t.clientId,{clientId:t.clientId,n:t.n,v:t.v,method:"RESPONSE"}))},undo:()=>{this.state.v=e,this.parentNode.state.log=s}}}}class C{constructor(t,e,s,n){this.id=t,this.config=s,this.parentNode=n,this.network=e,this.type="proposer",this.state={proposals:[],text:"IDLE"}}hasMajority(t,e="promises"){const s=this.state.proposals.find(i=>i.n===t);if(!s)return;const n=this.network.getNeighborsOfType("acceptors").length||this.network.getNeighborsOfType("node").length;return s[e].length>=Math.floor(.5*n)+1}onRequest(t){let e={state:a({},this.state),parentState:a({},this.parentNode.state)};return{do:()=>{this.state.isProposer=!0,this.state.text="PREPARING",this.parentNode.state.greatestN+=1,this.state.proposals.push({clientId:t.fromId,v:t.v,n:this.parentNode.state.greatestN,promises:[],acceptances:[],ignoredBy:[]});let s=this.network.getNeighborsOfType("acceptor");(!s||s.length===0)&&(s=this.network.getNeighborsOfType("node")),this.parentNode.state.log[this.parentNode.state.greatestN-1]=t.v,this.network.broadcast({clientId:t.fromId,method:"PREPARE",n:this.parentNode.state.greatestN},s.map(n=>n.id))},undo:()=>{this.state=e.state,this.parentNode.state=e.parentState}}}onPromise(t){const e=a({},this.state);return{do:()=>{const s=this.state.proposals.find(n=>n.n===t.n);if(!!s){if(this.hasMajority(t.n)){s.promises.push(t.fromId);return}else s.promises.push(t.fromId);this.hasMajority(t.n)&&(this.network.broadcastToType({clientId:t.clientId,method:"ACCEPT",n:s.n,v:s.v},"node"),this.state.text="PROMISED")}},undo:()=>{this.state=e}}}onAccepted(t){const e=a({},this.state);return{do:()=>{const s=this.state.proposals.find(n=>n.n===t.n);if(!!s){if(this.hasMajority(t.n,"acceptances")){s.acceptances.push(t.fromId);return}else s.acceptances.push(t.fromId);this.hasMajority(t.n,"acceptances")&&(this.state.text="IDLE"),this.state.isProposer=!1}},undo:()=>{this.state=e.state,this.parentNode.state=e.parentState}}}onIgnored(t){let e={state:a({},this.state),parentState:a({},this.parentNode.state)};return{do:()=>{if(t.n>this.parentNode.state.greatestN){this.parentNode.state.greatestN=t.n,this.state.isProposer=!1;return}else if(t.n<this.parentNode.state.greatestN)return;const s=this.state.proposals.findIndex(n=>n.n===t.n);s<0||!this.state.proposals[s]||(this.state.proposals=this.state.proposals.map(n=>n.n===t.n?h(a({},n),{acceptances:n.acceptances.filter(i=>i.acceptorId!==t.fromId),promises:n.promises.filter(i=>i.acceptorId!==t.fromId)}):n))},undo:()=>{this.state=e}}}}class x extends p{constructor(t,e,s,n,i="node"){super(t,e,s,n),this.type=i,this.state.log=[],this.state.greatestN=0,(i==="node"||i==="acceptor")&&(this.acceptor=new R(t,n,e,this),this.state.acceptor=this.acceptor.state),(i==="node"||i==="learner")&&(this.learner=new M(t,n,e,this),this.state.learner=this.learner.state),(i==="node"||i==="proposer")&&(this.proposer=new C(t,n,e,this),this.state.proposer=this.proposer.state)}onmessage(t){this.proposer&&this.handleProposerMessage(t),this.acceptor&&this.handleAcceptorMessage(t),this.learner&&this.handleLearnerMessage(t)}handleProposerMessage(t){switch(t.method){case"REQUEST":this.invoke(this.proposer.onRequest(t));break;case"PROMISE":this.invoke(this.proposer.onPromise(t));break;case"ACCEPTED":this.invoke(this.proposer.onAccepted(t));break;case"IGNORED":this.invoke(this.proposer.onIgnored(t));break}}handleAcceptorMessage(t){switch(t.method){case"PREPARE":this.invoke(this.acceptor.onPrepare(t));break;case"ACCEPT":this.invoke(this.acceptor.onAccept(t));break}}handleLearnerMessage(t){switch(t.method){case"ACCEPTED":this.invoke(this.learner.onAccepted(t));break}}}function A(o,t,e,s){return e.type==="client"?new S(e.id,o,e,s):new x(e.id,o,e,s,e.type||"all")}class O extends p{constructor(t,e,s,n){super(t,e,s,n),this.type="client"}request(t,e){const s=this.state.state;return{do:()=>{this.state.text="WAITING",this.network.sendTo(t,{command:"REQUEST",tx:e,timestamp:new Date().getTime()}),this.updateState()},undo:()=>{this.state.text=s}}}onAck(){const t=this.state.text;return{do:()=>{this.state.text="DONE"},undo:()=>{this.state.text=t}}}onmessage(t){t.method==="RESPONSE"&&this.invoke(this.onAck())}requestRandom(t){const e=this.network.getRandomNeighborOfType("node");this.invoke(this.request(e.id,t))}}const P={header:{prevHeaderHash:null,merkleRoot:null},height:0,timestamp:new Date("2009-01-03T19:15:00.000Z").getTime(),transactions:[]};async function w(o,t="",e="sha-256"){if(typeof crypto=="undefined"||!crypto||!crypto.subtle)return JSON.stringify(o)+t;const s=D(JSON.stringify(o)+t),n=await crypto.subtle.digest(e,s);return Array.from(new Uint8Array(n)).map(r=>r.toString(16).padStart(2,"0")).join("")}async function f(o,t,e="",s="sha-256"){return typeof crypto=="undefined"||!crypto||!crypto.subtle?JSON.stringify(t)+e===o:await w(t,e,s)===o}function D(o){return new TextEncoder().encode(o)}const m=5e3,c=1e3;class L extends p{constructor(t,e,s,n){super(t,e,s,n),this.type="node",this.state.text="IDLE",this.state.chain=[P],this.state.mempool=[],this.getBlocks(),this.sync=!0}onmessage(t){switch(t.command){case"getblocks":super.invoke(this.onGetBlocks(t));break;case"REQUEST":super.invokeDo(this.sendRawTransaction(t));break;case"blocks":super.invoke(this.onBlocks(t));break;case"rawtransaction":super.invokeDo(this.onRawTransaction(t));break;case"submitblock":super.invokeDo(this.onSubmitBlock(t));break}}onBlocks(t){return{do:async()=>{for(let e of t.entries){if(!await f(e.header.prevHeaderHash,this.state.chain.at(-1).header))return;this.state.chain.push(e)}},undo:()=>{}}}onGetBlocks(t){return{do:()=>{this.network.sendTo(t.fromId,{command:"blocks",entries:this.state.chain})},undo:()=>{}}}getBlocks(){if(this.network.neighbors.length===0)return;const t=this.network.getNeighborsOfType("node");if(t.length===0)return;const e=Math.floor(Math.random()*t.length),s=t[e];this.network.sendTo(s.id,{command:"getblocks",headerHashes:[this.state.chain.at(-1).hash]})}sendRawTransaction(t){return()=>{const e=this.state.mempool.find(n=>t.tx===n),s=this.state.chain.find(n=>n.transactions.find(i=>i===t.tx));if(!e&&!s){this.timeout&&clearTimeout(this.timeout);const n=Math.random()*(m-c)+c;this.timeout=setTimeout(this.tryMining(),n),this.state.mempool.push(t.tx),this.network.broadcastToType({timestamp:t.timestamp,tx:t.tx,command:"rawtransaction"},"node")}}}onRawTransaction(t){return()=>{this.sendRawTransaction(t)()}}onSubmitBlock(t){return()=>{const e=(n,i)=>()=>n.transactions.filter((r,k)=>r!==i.transactions[k]).length===0;this.state.chain.find(n=>n===t.block||e(t.block,n))||(this.state.mempool=this.state.mempool.filter(n=>!t.block.transactions.find(i=>i!==n)),this.state.chain.push(t.block))}}stop(){super.stop(),this.timeout&&clearTimeout(this.timeout)}restart(){super.restart();const t=Math.random()*(m-c)+c;this.timeout=setTimeout(this.tryMining(),t)}tryMining(){return async()=>{if(this.state.mempool.length===0)return;const t=Math.random().toFixed(8),s={header:{prevHeaderHash:await w(this.state.chain.at(-1),t),merkleRoot:null,nonce:t},height:this.state.chain.length,timestamp:new Date().getTime(),transactions:this.state.mempool};this.state.mempool=[],this.state.chain.push(s),this.network.broadcastToType({block:s,command:"submitblock"},"node")}}validate(t){return f(t.header.prevHeaderHash,h(a({},t),{hash:void 0}))}}function H(o,t,e,s){switch(e.type){case"client":return new O(e.id,o,e,s);case"node":return new L(e.id,o,e,s)}}function B(o,...t){switch(o){case"paxos":return A(...t);case"bitcoin_pow":return H(...t);default:throw"Algorithm not implemented"}}class G{constructor(t,e){this.setupNetwork=(s,n)=>new N(s,n),this.id=d(),this.config=t,this.network=null,this.nodeStates=e,this.nodes=[]}terminate(){this.stopListening&&this.stopListening()}buildMessageEventHandler(){return t=>{const e=t.data;if(console.log(`NodeRunner for "${this.nodeStates?this.nodeStates.map(s=>s.id).join(", "):"?"}" got:`,e),e.isFlow){this.onFlowMessage(e);return}if(e.toId){const s=this.nodes.find(n=>n.id===e.toId);s&&s.running&&s.connected&&s.onmessage(e)}}}setupNodes(t,e,s){this.nodeStates=e,e.forEach(async n=>{const i=this.setupNetwork(n,s),r=B(t.algorithm,t,null,n,i);r&&(r.updateState(),this.nodes.push(r),console.log("Starting node with id ",r.id,"and type",r.type))})}onFlowMessage(t){const{nodeId:e}=t;switch(t.type){case"CLIENT_REQUEST":if(e){const s=this.nodes.find(n=>n.id===e);if(s&&s.type==="client"){const{v:n}=t;s.requestRandom(n)}}break;case"SETUP":case"RESET":this.setupNodes(t.config,t.nodes,t.neighbors),this.postMessageToMain({isFlow:!0,type:"STATE_CHANGED",state:"IDLE"});break;case"STEP":this.nodes.forEach(s=>s.step(t.forward));break;case"DISCONNECT":case"RECONNECT":case"STOP":case"RESTART":if(e){const s=this.nodes.find(n=>n.id===e);s&&(t.type==="RECONNECT"?s.reconnect():t.type==="DISCONNECT"?s.disconnect():t.type==="RESTART"?s.restart():t.type==="STOP"&&(this.postMessageToMain({isFlow:!0,type:"COMMANDS",commands:s.executedCommands}),s.stop()))}break;default:console.error("Flow message type not recognized");break}}onmessage(){console.warn("onmessage is not implemented")}onerror(){console.warn("onerror is not implemented")}postMessage(t){this.messageEventHandler||(this.messageEventHandler=this.buildMessageEventHandler());const e={data:t};this.messageEventHandler(e)}postMessageToMain(t){window.dispatchEvent(new CustomEvent("NodeRunnerEvent",{detail:h(a({},t),{nodeRunnerId:this.id})}))}startListening(){const t=n=>n.detail.nodeRunnerId===this.id||this.nodeStates.filter(i=>i.id===n.detail.nodeId||i.id===n.detail.toId).length!==0,s=(n=>i=>t(i)&&n({data:i.detail}))(this.onmessage);window.addEventListener("NodeRunnerEvent",s),window.addEventListener("NetworkEvent",s),this.stopListening=()=>{window.removeEventListener("NodeRunnerEvent",s),window.removeEventListener("NetworkEvent",s)}}}class U extends G{constructor(){super(),this.setupNetwork=(t,e)=>new g(t,e),self.onmessage=this.buildMessageEventHandler(),this.postMessage=()=>!1,this.postMessageToMain=t=>self.postMessage(t)}}self.runner=new U;
